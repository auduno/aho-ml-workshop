<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>CocoSSD object detection example</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"> </script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"> </script>
</head>
<body>
    <div id='container'>
        <h1>Object Detection Example</h1>
        <div id='vid' style='position:relative;width:640px;height:480px'>
            <video id="video" width="640" height="480" autoplay style='position:absolute;top:0;left:0'></video>
            <canvas id="canvas" width="640" height="480" style='position:absolute;top:0;left:0'></canvas> 
        </div>
        <p id='result'>Loading model...</p>
        <h2>Coco ssd classes</h2>
        <ul>
            <li>person</li>
            <li>apple</li>
            <li>banana</li>
            <li>orange</li>
            <li>bottle</li>
            <li>wine glass</li>
            <li>cup</li>
            <li>fork</li>
            <li>knife</li>
            <li>spoon</li>
            <li>bowl</li>
            <li>sandwich</li>
            <li>broccoli</li>
            <li>carrot</li>
            <li>hot dog</li>
            <li>pizza</li>
            <li>donut</li>
            <li>cake</li>
            <li>laptop</li>
            <li>mouse</li>
            <li>remote</li>
            <li>keyboard</li>
            <li>cell phone</li>
            <li>book</li>
            <li>clock</li>
            <li>vase</li>
            <li>scissors</li>
            <li>teddy bear</li>
            <li>toothbrush</li>
        </ul>
    </div>
    <script>
        let detection_model;
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let objects = [];
        let width = 640;
        let height = 480;

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
                video.srcObject=stream;
                video.play();
                cocoSsd.load({'base':  'mobilenet_v2'}).then(modelReady);
            });
        }

        document.getElementById('result').textContent = 'Loading model...';

        function modelReady(model) {
            detection_model = model;
            document.getElementById('result').textContent = 'Model ready!';
            detectVideo();
        }

        // check https://codesandbox.io/s/z364noozrm
        function detectVideo() {
            detection_model.detect(video).then(predictions => {
                objects = predictions;
                draw();
                window.requestAnimationFrame(detectVideo);
            });
        }

        // function to draw bounding boxes and label
        function draw() {
            for (let i = 0; i < objects.length; i++) {
                ctx.clearRect(0,0, 640, 480);
                for (let i = 0; i < objects.length; i++) {
                    if (objects[i].score > 0.4) {
                        ctx.font = "16px Arial";
                        const textWidth = ctx.measureText(objects[i].class).width;
                        const textHeight = 20;
                        ctx.fillStyle = "yellow";
                        ctx.fillRect(objects[i].bbox[0], objects[i].bbox[1], textWidth+8, textHeight+4);
                        ctx.fillStyle = "black";
                        ctx.fillText(objects[i].class, objects[i].bbox[0] + 4, objects[i].bbox[1] + 16);

                        ctx.beginPath();
                        ctx.rect(objects[i].bbox[0], objects[i].bbox[1], objects[i].bbox[2], objects[i].bbox[3]);
                        ctx.strokeStyle = "yellow";
                        ctx.stroke();
                        ctx.closePath();
                    }
                }
            }
        }
    </script>
</body>
</html>